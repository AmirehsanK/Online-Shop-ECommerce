@model List<Domain.ViewModel.Permission.PermissionSelectionViewModel>

<div class="check-all-page-container">
    <button type="button" class="check-all-page-btn">انتخاب همه مجوزها</button>
</div>

<div class="permission-container">
    @foreach (var permission in Model)
    {
        <div class="permission-box">
            <!-- Parent Permission -->
            <div class="parent-permission">
                <div>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               name="Permissions[@permission.PermissionId].IsSelected" 
                               value="true" 
                               @(permission.IsSelected ? "checked" : "") 
                               data-permission-id="@permission.PermissionId" 
                               data-parent-id="@permission.ParentId" 
                               class="permission-checkbox parent-checkbox" />
                        <span class="slider"></span>
                    </label>
                    <span class="permission-name">@permission.DisplayName</span>
                </div>
                <button type="button" class="check-all-btn" 
                        data-parent-id="@permission.PermissionId" 
                        data-checked="false"><i class="fa-solid fa-check-double"></i></button>
            </div>

            <!-- Child Permissions -->
            @if (permission.Children.Any())
            {
                <ul class="child-permissions">
                    @foreach (var child in permission.Children)
                    {
                        <li>
                            <label class="toggle-switch">
                                <input type="checkbox"
                                       name="Permissions[@child.PermissionId].IsSelected"
                                       value="true"
                                       @(child.IsSelected ? "checked" : "")
                                       data-permission-id="@child.PermissionId"
                                       data-parent-id="@permission.PermissionId"
                                       class="permission-checkbox"/>
                                <span class="slider"></span>
                            </label>
                            <span class="permission-name">@child.DisplayName</span>
                        </li>
                    }
                </ul>
            }
        </div>
    }
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const permissionCheckboxes = document.querySelectorAll(".permission-checkbox");
        const checkAllButtons = document.querySelectorAll(".check-all-btn");
        const checkAllPageButton = document.querySelector(".check-all-page-btn");

        // Update button state
        function updateButtonState(button, allChecked) {
            if (allChecked) {
                button.textContent = "لغو انتخاب همه";
                button.style.backgroundColor = "red";
                button.dataset.checked = "true";
            } else {
                button.textContent = "انتخاب همه";
                button.style.backgroundColor = "#4CAF50";
                button.dataset.checked = "false";
            }
        }

        // Handle "Check All" for individual groups
        checkAllButtons.forEach(button => {
            button.addEventListener("click", function () {
                const parentId = button.dataset.parentId;
                const childCheckboxes = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
                const allChecked = button.dataset.checked === "true";

                childCheckboxes.forEach(childCheckbox => {
                    childCheckbox.checked = !allChecked;
                    childCheckbox.dispatchEvent(new Event("change", { bubbles: true }));
                });

                const parentCheckbox = document.querySelector(`[data-permission-id="${parentId}"]`);
                if (parentCheckbox) {
                    parentCheckbox.checked = !allChecked;
                }

                updateButtonState(button, !allChecked);
            });
        });

        // Handle "Check All" for the entire page
        checkAllPageButton.addEventListener("click", function () {
            const allChecked = checkAllPageButton.dataset.checked === "true";

            permissionCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                checkbox.dispatchEvent(new Event("change", { bubbles: true }));
            });

            checkAllButtons.forEach(button => {
                updateButtonState(button, !allChecked);
            });

            updateButtonState(checkAllPageButton, !allChecked);
        });

        // Initialize button states
        function initializeButtonStates() {
            checkAllButtons.forEach(button => {
                const parentId = button.dataset.parentId;
                const childCheckboxes = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
                const allChecked = Array.from(childCheckboxes).every(child => child.checked);

                updateButtonState(button, allChecked);
            });

            const allChecked = Array.from(permissionCheckboxes).every(checkbox => checkbox.checked);
            updateButtonState(checkAllPageButton, allChecked);
        }

        // Initialize parent checkboxes
        function initializeParentCheckboxes() {
            const parentCheckboxes = document.querySelectorAll(".permission-checkbox[data-parent-id='']");
            parentCheckboxes.forEach(parentCheckbox => {
                const permissionId = parentCheckbox.dataset.permissionId;
                const childCheckboxes = document.querySelectorAll(`[data-parent-id="${permissionId}"]`);
                const atLeastOneChildChecked = Array.from(childCheckboxes).some(child => child.checked);

                parentCheckbox.checked = atLeastOneChildChecked;
            });
        }

        initializeParentCheckboxes();
        initializeButtonStates();

        // Handle checkbox change events
        permissionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                const parentId = checkbox.dataset.parentId;

                if (!parentId) {
                    const childCheckboxes = document.querySelectorAll(`[data-parent-id="${checkbox.dataset.permissionId}"]`);
                    childCheckboxes.forEach(childCheckbox => {
                        childCheckbox.checked = checkbox.checked;
                    });
                } else {
                    const parentCheckbox = document.querySelector(`[data-permission-id="${parentId}"]`);
                    const childCheckboxes = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
                    const allChecked = Array.from(childCheckboxes).every(child => child.checked);

                    parentCheckbox.checked = allChecked;
                }

                initializeButtonStates();
            });
        });
    });
</script>
